{{- range $name, $knight := .Values.knights }}
{{- if $knight.enabled }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: knight-{{ $name }}-config
  namespace: {{ $.Values.namespace }}
  labels:
    {{- include "roundtable.knightLabels" (dict "ctx" $ "name" $name "knight" $knight) | nindent 4 }}
data:
  openclaw.json: |
    {
      "auth": {
        "profiles": {
          "anthropic:default": {
            "provider": "anthropic",
            "mode": "token"
          }
        }
      },
      {{- if ($knight.chrome | default dict).enabled }}
      "browser": {
        "enabled": true,
        "attachOnly": true,
        "defaultProfile": "sidecar",
        "profiles": {
          "sidecar": {
            "cdpUrl": "http://localhost:9222"
          }
        }
      },
      {{- end }}
      "agents": {
        "defaults": {
          "model": {
            "primary": {{ $knight.model | quote }}
          },
          "workspace": "/home/node/{{ $name }}",
          "maxConcurrent": 2,
          "subagents": {
            "maxConcurrent": 4
          }
        },
        "list": [
          {
            "id": "main"
          }
        ]
      },
      "gateway": {
        "port": {{ $.Values.openclaw.port }},
        "mode": "local",
        "bind": "lan",
        "auth": {
          "mode": "token"
        },
        "trustedProxies": [
          "10.0.0.0/8",
          "172.16.0.0/12",
          "192.168.0.0/16"
        ]
      },
      "skills": {
        "load": {
          "extraDirs": ["/home/node/{{ $name }}/skills"]
        }
      }
    }
{{- end }}
{{- end }}
