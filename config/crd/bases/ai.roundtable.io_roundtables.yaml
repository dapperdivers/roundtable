---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.20.1
  name: roundtables.ai.roundtable.io
spec:
  group: ai.roundtable.io
  names:
    kind: RoundTable
    listKind: RoundTableList
    plural: roundtables
    shortNames:
    - rt
    singular: roundtable
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .status.phase
      name: Phase
      type: string
    - description: Ready/Total knights
      jsonPath: .status.knightsReady
      name: Knights
      type: string
    - jsonPath: .status.knightsTotal
      name: Total
      type: integer
    - jsonPath: .status.totalTasksCompleted
      name: Tasks
      type: integer
    - jsonPath: .status.totalCost
      name: Cost
      type: string
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: |-
          RoundTable is the Schema for the roundtables API.
          A RoundTable represents a fleet of knights with shared configuration,
          NATS infrastructure, and operational policies. It is the top-level
          organizational resource in the Round Table operator.
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: spec defines the desired state of RoundTable
            properties:
              defaults:
                description: |-
                  defaults defines default configuration applied to all knights in this table.
                  Individual knight specs can override these values.
                properties:
                  arsenal:
                    description: arsenal configures the default skill arsenal for
                      knights.
                    properties:
                      image:
                        default: registry.k8s.io/git-sync/git-sync:v4.4.0
                        description: image overrides the git-sync container image.
                        type: string
                      period:
                        default: 300s
                        description: period is how often to sync (e.g., "300s").
                        type: string
                      ref:
                        default: main
                        description: ref is the git ref to sync.
                        type: string
                      repo:
                        default: https://github.com/dapperdivers/roundtable-arsenal
                        description: repo is the git repository URL containing skills.
                        type: string
                    type: object
                  concurrency:
                    default: 2
                    description: concurrency is the default max concurrent tasks per
                      knight.
                    format: int32
                    type: integer
                  image:
                    description: image is the default container image for knights.
                    type: string
                  model:
                    description: model is the default AI model for knights in this
                      table.
                    type: string
                  resources:
                    description: resources defines default compute resource requirements.
                    properties:
                      cpu:
                        anyOf:
                        - type: integer
                        - type: string
                        default: 200m
                        description: cpu is the CPU limit for the knight container.
                        pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                        x-kubernetes-int-or-string: true
                      memory:
                        anyOf:
                        - type: integer
                        - type: string
                        default: 256Mi
                        description: memory is the memory limit for the knight container.
                        pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                        x-kubernetes-int-or-string: true
                    type: object
                  taskTimeout:
                    default: 120
                    description: taskTimeout is the default task timeout in seconds.
                    format: int32
                    type: integer
                type: object
              description:
                description: description is a human-readable description of this round
                  table's purpose.
                type: string
              knightSelector:
                description: |-
                  knightSelector is a label selector for Knights that belong to this table.
                  Knights matching this selector are automatically managed by this RoundTable.
                properties:
                  matchExpressions:
                    description: matchExpressions is a list of label selector requirements.
                      The requirements are ANDed.
                    items:
                      description: |-
                        A label selector requirement is a selector that contains values, a key, and an operator that
                        relates the key and values.
                      properties:
                        key:
                          description: key is the label key that the selector applies
                            to.
                          type: string
                        operator:
                          description: |-
                            operator represents a key's relationship to a set of values.
                            Valid operators are In, NotIn, Exists and DoesNotExist.
                          type: string
                        values:
                          description: |-
                            values is an array of string values. If the operator is In or NotIn,
                            the values array must be non-empty. If the operator is Exists or DoesNotExist,
                            the values array must be empty. This array is replaced during a strategic
                            merge patch.
                          items:
                            type: string
                          type: array
                          x-kubernetes-list-type: atomic
                      required:
                      - key
                      - operator
                      type: object
                    type: array
                    x-kubernetes-list-type: atomic
                  matchLabels:
                    additionalProperties:
                      type: string
                    description: |-
                      matchLabels is a map of {key,value} pairs. A single {key,value} in the matchLabels
                      map is equivalent to an element of matchExpressions, whose key field is "key", the
                      operator is "In", and the values array contains only "value". The requirements are ANDed.
                    type: object
                type: object
                x-kubernetes-map-type: atomic
              nats:
                description: nats configures the shared NATS infrastructure for all
                  knights in this table.
                properties:
                  createStreams:
                    default: false
                    description: createStreams, if true, tells the controller to create/update
                      the JetStream streams.
                    type: boolean
                  resultsStream:
                    description: resultsStream is the JetStream stream name for results.
                    type: string
                  streamRetention:
                    default: WorkQueue
                    description: streamRetention configures the retention policy for
                      auto-created streams.
                    enum:
                    - Limits
                    - Interest
                    - WorkQueue
                    type: string
                  subjectPrefix:
                    description: |-
                      subjectPrefix is the NATS subject prefix for this table (e.g., "fleet-a").
                      All knights in this table use subjects under this prefix.
                    minLength: 1
                    type: string
                  tasksStream:
                    description: tasksStream is the JetStream stream name for tasks.
                    type: string
                  url:
                    default: nats://nats.database.svc:4222
                    description: url is the NATS server URL.
                    type: string
                required:
                - resultsStream
                - subjectPrefix
                - tasksStream
                type: object
              policies:
                description: policies defines fleet-level operational policies.
                properties:
                  costBudgetUSD:
                    default: "0"
                    description: |-
                      costBudgetUSD is the maximum cumulative cost in USD across all knights.
                      When reached, all knights are suspended. "0" means unlimited.
                    type: string
                  costResetSchedule:
                    description: costResetSchedule is a cron expression for resetting
                      the cost counter (e.g., "0 0 1 * *" for monthly).
                    type: string
                  maxConcurrentTasks:
                    default: 0
                    description: |-
                      maxConcurrentTasks is the maximum total concurrent tasks across all knights in this table.
                      0 means unlimited.
                    format: int32
                    minimum: 0
                    type: integer
                  maxKnights:
                    default: 0
                    description: |-
                      maxKnights is the maximum number of knights allowed in this table.
                      0 means unlimited.
                    format: int32
                    minimum: 0
                    type: integer
                  maxMissions:
                    default: 5
                    description: maxMissions is the maximum number of concurrent active
                      missions.
                    format: int32
                    minimum: 0
                    type: integer
                type: object
              secrets:
                description: secrets references shared secrets available to all knights
                  in this table.
                items:
                  description: |-
                    LocalObjectReference contains enough information to let you locate the
                    referenced object inside the same namespace.
                  properties:
                    name:
                      default: ""
                      description: |-
                        Name of the referent.
                        This field is effectively required, but due to backwards compatibility is
                        allowed to be empty. Instances of this type with an empty value here are
                        almost certainly wrong.
                        More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names
                      type: string
                  type: object
                  x-kubernetes-map-type: atomic
                type: array
              suspended:
                default: false
                description: suspended, if true, suspends all knights in this table.
                type: boolean
              vault:
                description: vault configures the shared Obsidian vault for all knights
                  in this table.
                properties:
                  claimName:
                    default: obsidian-vault
                    description: claimName is the PVC name for the shared vault.
                    type: string
                  readOnly:
                    default: true
                    description: readOnly mounts the base vault as read-only.
                    type: boolean
                  writablePaths:
                    default:
                    - Briefings/
                    - Roundtable/
                    description: writablePaths are subpaths within the vault the knight
                      can write to.
                    items:
                      type: string
                    type: array
                type: object
            required:
            - nats
            type: object
          status:
            description: status defines the observed state of RoundTable
            properties:
              activeMissions:
                description: activeMissions is the number of currently active missions
                  under this table.
                format: int32
                type: integer
              conditions:
                description: conditions represent the current state of the RoundTable
                  resource.
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
                x-kubernetes-list-map-keys:
                - type
                x-kubernetes-list-type: map
              knights:
                description: knights provides a summary of each knight's status.
                items:
                  description: RoundTableKnightSummary provides an aggregated view
                    of a knight's status.
                  properties:
                    name:
                      description: name is the knight name.
                      type: string
                    phase:
                      description: phase is the knight's current phase.
                      enum:
                      - Pending
                      - Provisioning
                      - Ready
                      - Degraded
                      - Suspended
                      type: string
                    ready:
                      description: ready indicates whether this knight is ready.
                      type: boolean
                  required:
                  - name
                  type: object
                type: array
              knightsReady:
                description: knightsReady is the number of knights in Ready phase.
                format: int32
                type: integer
              knightsTotal:
                description: knightsTotal is the total number of knights in this table.
                format: int32
                type: integer
              observedGeneration:
                description: observedGeneration is the most recent generation observed
                  by the controller.
                format: int64
                type: integer
              phase:
                description: phase is the current lifecycle phase of the round table.
                enum:
                - Provisioning
                - Ready
                - Degraded
                - Suspended
                - OverBudget
                type: string
              totalCost:
                description: totalCost is the aggregate cost in USD across all knights
                  since last reset.
                type: string
              totalTasksCompleted:
                description: totalTasksCompleted is the aggregate tasks completed
                  across all knights.
                format: int64
                type: integer
            type: object
        required:
        - spec
        type: object
    served: true
    storage: true
    subresources:
      status: {}
